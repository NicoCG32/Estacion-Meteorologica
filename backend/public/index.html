<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estación Meteorológica – Región de Coquimbo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-page: #e5e7eb;
      --bg-card: #ffffff;
      --border-card: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent-blue: #2563eb;
      --accent-green: #16a34a;
      --accent-orange: #f97316;
      --accent-purple: #7c3aed;
      --radius-lg: 16px;
      --shadow-soft: 0 12px 24px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.25rem;
      background: radial-gradient(circle at top left, #f9fafb 0, #e5e7eb 45%, #d1d5db 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Cabecera con logos */
    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      padding: 1.25rem 1.5rem;
      border-radius: var(--radius-lg);
      background: #ffffff;
      box-shadow: var(--shadow-soft);
      border: 1px solid #e5e7eb;
    }

    .header-text {
      max-width: 100%;
    }

    .logo-estacion {
      display: block;
      max-width: 100%;
      max-height: 120px;   /* Logo largo de la estación */
      height: auto;
      margin-bottom: 0.5rem;
    }

    .header-text h1 {
      margin: 0 0 0.35rem 0;
      font-size: clamp(1.4rem, 2vw + 0.9rem, 1.9rem);
      letter-spacing: 0.03em;
    }

    .header-text .subtitle {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .header-text .subtitle span {
      color: var(--accent-blue);
      font-weight: 600;
    }

    .header-logos {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
    }

    .header-logos img {
      display: block;
    }

    .logo-main {
      max-height: 110px;  /* logos más grandes */
      width: auto;
    }

    .logo-ecin {
      max-height: 70px;
      width: auto;
      opacity: 0.97;
    }

    @media (max-width: 720px) {
      .site-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-logos {
        flex-direction: row;
        align-items: center;
      }
      .header-text {
        width: 100%;
      }
      .logo-estacion {
        max-height: 100px;
      }
    }

    /* Tarjetas y layout principal */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1rem 1.1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border-card);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.06);
    }

    .card h2 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.87rem;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.35rem 0.3rem;
      text-align: left;
    }
    tr:last-child td {
      border-bottom: none;
    }
    th {
      background-color: #f3f4f6;
      font-weight: 600;
      color: var(--text-muted);
    }
    .label {
      font-weight: 500;
      color: var(--text-muted);
      width: 55%;
    }
    .value {
      font-family: "JetBrains Mono", "Consolas", monospace;
      font-size: 0.82rem;
    }

    pre {
      font-size: 0.78rem;
      background: #111827;
      color: #e5e7eb;
      padding: 0.6rem 0.7rem;
      border-radius: 10px;
      border: 1px solid #1f2937;
      overflow-x: auto;
    }

    /* Tabla sensores */
    .sensor-table td.value {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .sensor-icon {
      font-size: 1rem;
      width: 1.2rem;
      text-align: center;
    }
    .sensor-ok {
      color: #16a34a;
    }
    .sensor-bad {
      color: #b91c1c;
    }
    .sensor-unknown {
      color: #6b7280;
    }

    /* Gráficos */
    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 1rem;
    }

    @media (max-width: 900px) {
      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chart-card h2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-tag {
      padding: 0.12rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid #cbd5f5;
      color: var(--text-muted);
      background: #eef2ff;
    }

    #chart-container-temp,
    #chart-container-co2,
    #chart-container-hum,
    #chart-container-pres {
      width: 100%;
      height: 260px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 0.3rem;
    }

    #chartTemp,
    #chartCo2,
    #chartHum,
    #chartPres {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      background: #ffffff;
    }

    .hint {
      margin-top: 0.4rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* Estado servidor: un poco más compacto */
    #estado-servidor p {
      margin: 0.15rem 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="site-header">
      <div class="header-text">
        <img src="img/esta.png" alt="Logo Estación Meteorológica" class="logo-estacion" />
        <h1>Estación Meteorológica – Región de Coquimbo</h1>
        <p class="subtitle">
          Monitoreo local de <span>temperatura</span>, <span>humedad</span>, <span>presión</span> y <span>CO₂</span>
        </p>
      </div>
      <div class="header-logos">
        <img src="img/logo.png" alt="Logo Universidad" class="logo-main" />
        <img src="img/ecin.png" alt="Logo ECIN" class="logo-ecin" />
      </div>
    </header>

    <main>
      <!-- Estado de sensores y GPS -->
      <div class="card" id="estado-sensores">
        <h2>Estado de sensores y GPS</h2>
        <table class="sensor-table">
          <tbody>
            <tr>
              <td class="label">BME280 (T, HR, P)</td>
              <td class="value">
                <span id="icon-bme" class="sensor-icon sensor-unknown">–</span>
                <span id="estado-bme">Sin datos</span>
              </td>
            </tr>
            <tr>
              <td class="label">SCD4x (CO₂, T, HR)</td>
              <td class="value">
                <span id="icon-scd" class="sensor-icon sensor-unknown">–</span>
                <span id="estado-scd">Sin datos</span>
              </td>
            </tr>
            <tr>
              <td class="label">DHT22 (T, HR)</td>
              <td class="value">
                <span id="icon-dht" class="sensor-icon sensor-unknown">–</span>
                <span id="estado-dht">Sin datos</span>
              </td>
            </tr>
            <tr>
              <td class="label">GPS (posición y satélites)</td>
              <td class="value">
                <span id="icon-gps" class="sensor-icon sensor-unknown">–</span>
                <span id="estado-gps">Sin datos</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card" id="estado-servidor">
        <h2>Estado del servidor</h2>
        <p><span class="label">Estado:</span> <span class="value" id="status-text">–</span></p>
        <p><span class="label">Mediciones totales:</span> <span class="value" id="total-mediciones">0</span></p>
        <p><span class="label">Última actualización:</span> <span class="value" id="ultima-actualizacion">–</span></p>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Última medición oficial (promedio 1 min)</h2>
          <table>
            <tbody>
              <tr><td class="label">Timestamp (servidor)</td><td class="value" id="last-ts">–</td></tr>
              <tr><td class="label">Temperatura aire [°C]</td><td class="value" id="last-temp">–</td></tr>
              <tr><td class="label">Incertidumbre Temp [°C]</td><td class="value" id="last-temp-incert">–</td></tr>
              <tr><td class="label">Humedad aire [%]</td><td class="value" id="last-hum">–</td></tr>
              <tr><td class="label">Incertidumbre Hum [%]</td><td class="value" id="last-hum-incert">–</td></tr>
              <tr><td class="label">Presión atmosférica [hPa]</td><td class="value" id="last-pres">–</td></tr>
              <tr><td class="label">CO₂ [ppm]</td><td class="value" id="last-co2">–</td></tr>
              <tr><td class="label">Latitud [°]</td><td class="value" id="last-lat">–</td></tr>
              <tr><td class="label">Longitud [°]</td><td class="value" id="last-lon">–</td></tr>
              <tr><td class="label">Número de satélites</td><td class="value" id="last-sat">–</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>JSON crudo de la última medición</h2>
          <pre id="last-json">{ }</pre>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card chart-card">
          <h2>
            Temperatura del aire vs tiempo
            <span class="chart-tag">°C</span>
          </h2>
          <div id="chart-container-temp">
            <canvas id="chartTemp"></canvas>
          </div>
          <p class="hint">Últimos 60 puntos (minutos, si hay datos suficientes) de temperatura fusionada.</p>
        </div>

        <div class="card chart-card">
          <h2>
            CO₂ vs tiempo
            <span class="chart-tag">ppm</span>
          </h2>
          <div id="chart-container-co2">
            <canvas id="chartCo2"></canvas>
          </div>
          <p class="hint">Últimos 60 puntos de concentración media de CO₂.</p>
        </div>

        <div class="card chart-card">
          <h2>
            Humedad relativa vs tiempo
            <span class="chart-tag">% HR</span>
          </h2>
          <div id="chart-container-hum">
            <canvas id="chartHum"></canvas>
          </div>
          <p class="hint">Últimos 60 puntos de humedad relativa fusionada.</p>
        </div>

        <div class="card chart-card">
          <h2>
            Presión atmosférica vs tiempo
            <span class="chart-tag">hPa</span>
          </h2>
          <div id="chart-container-pres">
            <canvas id="chartPres"></canvas>
          </div>
          <p class="hint">Últimos 60 puntos de presión atmosférica media (BME280).</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    const labels = [];    // timestamps (texto)
    const tempData = [];  // temperatura
    const co2Data  = [];  // CO2
    const humData  = [];  // humedad relativa
    const presData = [];  // presión
    const MAX_POINTS = 60;

    function formatearFloat(value, decimals) {
      if (value === null || value === undefined) return '–';
      if (typeof value !== 'number') return String(value);
      return value.toFixed(decimals);
    }

    function formatearCoord(value) {
      if (value === null || value === undefined) return '–';
      const n = Number(value);
      if (Number.isNaN(n)) return '–';
      return n.toFixed(6);
    }

    function setSensorEstado(iconId, textId, ok, textoOk, textoBad) {
      const iconEl = document.getElementById(iconId);
      const textEl = document.getElementById(textId);
      if (!iconEl || !textEl) return;

      if (ok === null) {
        iconEl.textContent = '–';
        iconEl.className = 'sensor-icon sensor-unknown';
        textEl.textContent = 'Sin datos';
        textEl.style.color = '#6b7280';
      } else if (ok) {
        iconEl.textContent = '✅';
        iconEl.className = 'sensor-icon sensor-ok';
        textEl.textContent = textoOk;
        textEl.style.color = '#16a34a';
      } else {
        iconEl.textContent = '⚠️';
        iconEl.className = 'sensor-icon sensor-bad';
        textEl.textContent = textoBad;
        textEl.style.color = '#b91c1c';
      }
    }

    // Actualización del bloque de sensores y GPS a partir de la última medición
    function actualizarEstadoSensores(m) {
      if (!m) {
        setSensorEstado('icon-bme', 'estado-bme', null);
        setSensorEstado('icon-scd', 'estado-scd', null);
        setSensorEstado('icon-dht', 'estado-dht', null);
        setSensorEstado('icon-gps', 'estado-gps', null);
        return;
      }

      // BME280: inferimos por presión disponible
      const pres = m.presion_atmosferica_hPa;
      const bmeOk = (typeof pres === 'number' && !Number.isNaN(pres));
      setSensorEstado(
        'icon-bme',
        'estado-bme',
        bmeOk,
        'OK (presión válida recibida)',
        'Sin presión válida (revisar BME280)'
      );

      // SCD4x: inferimos por CO2 > 0
      const co2 = m.concentracion_CO2_ppm;
      const scdOk = (typeof co2 === 'number' && co2 > 0 && !Number.isNaN(co2));
      setSensorEstado(
        'icon-scd',
        'estado-scd',
        scdOk,
        'OK (CO₂ válido recibido)',
        'Sin datos de CO₂ (revisar SCD4x)'
      );

      // DHT22: no hay campo específico en el JSON (solo llega fusión), lo marcamos como no observable
      const iconDht = document.getElementById('icon-dht');
      const textDht = document.getElementById('estado-dht');
      if (iconDht && textDht) {
        iconDht.textContent = '⚠️';
        iconDht.className = 'sensor-icon sensor-bad';
        textDht.textContent = 'Estado no observable desde el servidor (no se envía dato propio del DHT22)';
        textDht.style.color = '#b45309';
      }

      // GPS: inferimos por satélites y posición válidos
      const sat = m.numero_satelites;
      const lat = m.latitud_grados;
      const lon = m.longitud_grados;
      const gpsOk =
        typeof sat === 'number' && sat > 0 &&
        typeof lat === 'number' && !Number.isNaN(lat) &&
        typeof lon === 'number' && !Number.isNaN(lon);

      setSensorEstado(
        'icon-gps',
        'estado-gps',
        gpsOk,
        'OK (satélites y posición válidos)',
        'Sin posición o satélites (GPS aún sin fix o desconectado)'
      );
    }

    function actualizarEstadoServidor(data) {
      document.getElementById('status-text').textContent = data.status || 'desconocido';
      document.getElementById('total-mediciones').textContent = data.mediciones_totales ?? 0;

      if (data.ultima_medicion) {
        const ts = data.ultima_medicion.timestamp;
        const tsLocal = ts ? new Date(ts).toLocaleString() : '–';
        document.getElementById('ultima-actualizacion').textContent = tsLocal;
      } else {
        document.getElementById('ultima-actualizacion').textContent = '–';
        actualizarEstadoSensores(null);
      }
    }

    function actualizarUltimaMedicion(m) {
      if (!m) {
        actualizarEstadoSensores(null);
        return;
      }

      const tsLocal = m.timestamp ? new Date(m.timestamp).toLocaleString() : '–';
      document.getElementById('last-ts').textContent = tsLocal;

      document.getElementById('last-temp').textContent =
        formatearFloat(m.temperatura_aire_celsius, 2);
      document.getElementById('last-temp-incert').textContent =
        formatearFloat(m.incertidumbre_temperatura_celsius, 2);
      document.getElementById('last-hum').textContent =
        formatearFloat(m.humedad_aire_porcentaje, 1);
      document.getElementById('last-hum-incert').textContent =
        formatearFloat(m.incertidumbre_humedad_porcentaje, 1);
      document.getElementById('last-pres').textContent =
        formatearFloat(m.presion_atmosferica_hPa, 1);
      document.getElementById('last-co2').textContent =
        formatearFloat(m.concentracion_CO2_ppm, 0);
      document.getElementById('last-lat').textContent =
        formatearCoord(m.latitud_grados);
      document.getElementById('last-lon').textContent =
        formatearCoord(m.longitud_grados);
      document.getElementById('last-sat').textContent =
        (m.numero_satelites ?? '–');

      document.getElementById('last-json').textContent =
        JSON.stringify(m, null, 2);

      // Actualizamos también el bloque de sensores y GPS
      actualizarEstadoSensores(m);
    }

    function drawLineChart(canvasId, data, color, label, unit) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const rect = canvas.getBoundingClientRect();
      const width = canvas.width = rect.width || 600;
      const height = canvas.height = rect.height || 260;

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, width, height);

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);

      const margin = 32;
      const plotW = width - 2 * margin;
      const plotH = height - 2 * margin;

      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      ctx.strokeRect(margin, margin, plotW, plotH);

      const valid = data.filter(v => typeof v === 'number');

      if (labels.length === 0 || valid.length === 0) {
        ctx.fillStyle = '#9ca3af';
        ctx.font = '13px system-ui';
        ctx.fillText('Sin datos aún (esperando mediciones)...', margin + 10, margin + plotH / 2);
        return;
      }

      const vMin = Math.min(...valid);
      const vMax = Math.max(...valid);
      const range = (vMax - vMin) || 1;
      const n = labels.length;

      function xPos(i) {
        if (n <= 1) return margin + plotW / 2;
        return margin + (i / (n - 1)) * plotW;
      }

      function yPos(v) {
        return margin + (1 - (v - vMin) / range) * plotH;
      }

      ctx.fillStyle = '#4b5563';
      ctx.font = '11px system-ui';
      ctx.fillText(`${vMax.toFixed(2)} ${unit}`, 4, margin + 10);
      ctx.fillText(`${vMin.toFixed(2)} ${unit}`, 4, margin + plotH);

      const firstLabel = labels[0];
      const lastLabel = labels[labels.length - 1];
      ctx.fillStyle = '#9ca3af';
      ctx.font = '10px system-ui';
      ctx.fillText(firstLabel, margin, margin + plotH + 16);
      ctx.textAlign = 'right';
      ctx.fillText(lastLabel, margin + plotW, margin + plotH + 16);
      ctx.textAlign = 'left';

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      let started = false;
      for (let i = 0; i < n; i++) {
        const v = data[i];
        if (typeof v !== 'number') continue;
        const x = xPos(i);
        const y = yPos(v);
        if (!started) {
          ctx.moveTo(x, y);
          started = true;
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();

      ctx.font = '11px system-ui';
      ctx.fillStyle = color;
      ctx.fillText(label, margin + 10, margin - 12);
    }

    function drawCharts() {
      drawLineChart('chartTemp', tempData,  '#2563eb', 'Temperatura del aire', '°C');
      drawLineChart('chartCo2',  co2Data,   '#16a34a', 'CO₂', 'ppm');
      drawLineChart('chartHum',  humData,   '#f97316', 'Humedad relativa', '%');
      drawLineChart('chartPres', presData,  '#7c3aed', 'Presión atmosférica', 'hPa');
    }

    function agregarPuntoAlGrafico(m) {
      if (!m) return;

      const tsLabel = m.timestamp
        ? new Date(m.timestamp).toLocaleTimeString()
        : new Date().toLocaleTimeString();

      labels.push(tsLabel);
      tempData.push(
        (typeof m.temperatura_aire_celsius === 'number')
          ? m.temperatura_aire_celsius
          : null
      );
      co2Data.push(
        (typeof m.concentracion_CO2_ppm === 'number')
          ? m.concentracion_CO2_ppm
          : null
      );
      humData.push(
        (typeof m.humedad_aire_porcentaje === 'number')
          ? m.humedad_aire_porcentaje
          : null
      );
      presData.push(
        (typeof m.presion_atmosferica_hPa === 'number')
          ? m.presion_atmosferica_hPa
          : null
      );

      if (labels.length > MAX_POINTS) {
        labels.shift();
        tempData.shift();
        co2Data.shift();
        humData.shift();
        presData.shift();
      }

      drawCharts();
    }

    async function cargarEstadoInicial() {
      try {
        const resp = await fetch('/api/status');
        if (!resp.ok) return;
        const data = await resp.json();
        actualizarEstadoServidor(data);
        if (data.ultima_medicion) {
          actualizarUltimaMedicion(data.ultima_medicion);
        } else {
          actualizarEstadoSensores(null);
        }
      } catch (err) {
        console.error('Error al cargar estado inicial:', err);
      }
    }

    async function cargarHistorialInicial() {
      try {
        const resp = await fetch('/api/mediciones?limit=60');
        if (!resp.ok) return;
        const lista = await resp.json();
        lista.forEach(m => agregarPuntoAlGrafico(m));
      } catch (err) {
        console.error('Error al cargar historial inicial:', err);
      }
    }

    async function actualizarPeriodicamente() {
      try {
        const respStatus = await fetch('/api/status');
        if (respStatus.ok) {
          const status = await respStatus.json();
          actualizarEstadoServidor(status);
        }

        const respUltimo = await fetch('/api/mediciones/ultimo');
        if (respUltimo.ok) {
          const m = await respUltimo.json();
          actualizarUltimaMedicion(m);
          const ultimaLabel = labels.length > 0 ? labels[labels.length - 1] : null;
          const nuevaLabel = m.timestamp
            ? new Date(m.timestamp).toLocaleTimeString()
            : null;
          if (!ultimaLabel || ultimaLabel !== nuevaLabel) {
            agregarPuntoAlGrafico(m);
          }
        }
      } catch (err) {
        console.error('Error en actualización periódica:', err);
      }
    }

    window.addEventListener('load', async () => {
      drawCharts();              // inicial (sin datos)
      await cargarEstadoInicial();
      await cargarHistorialInicial();
      setInterval(actualizarPeriodicamente, 10000); // cada 10 s
    });
  </script>
</body>
</html>
